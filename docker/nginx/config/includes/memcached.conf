location / {
    set            $memcached_key "$uri";
    add_header X-uri "$uri";
    add_header X-ifarmer-Cache $upstream_cache_status;
    memcached_pass memcached:11211;

    error_page     404 502 504 = @fallback;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host $http_host;
      proxy_set_header X-NginX-Proxy true;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_max_temp_file_size 0;
      proxy_pass http://web;
      proxy_redirect off;
      proxy_read_timeout 240s;
}

location @fallback {
    proxy_pass     http://frontend;
}